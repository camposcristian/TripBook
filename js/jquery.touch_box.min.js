/**
    Touch box - Enabled resize, drag & rotate of DOM elements on the web for iPad and other touch devices.
    Copyright (C) 2013 Dannie Hansen
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
 **/
(function(f){for(var q=400,n="Transform",r="TransformOrigin",k=["O","ms","Webkit","Moz"],l=k.length,D=document.createElement("div").style;l--;)k[l]+n in D&&(n=k[l]+n,r=k[l]+r);f.fn.TouchBox=function(j){var c={drag:!1,resize:!1,rotate:!1,rotate_start:25,callback_touches:null,callback_size_change:null,callback_position_change:null,callback_degree_change:null};void 0!=j&&f.extend(c,j);this.each(function(){var g=f(this),d=0,j=0,u=0,k=0,l=0,p=0,m=!1,v=0,w=0,x=0,y=0,z=0,A=0,s=!1,B=0,t=0,C=0;c.rotate&&(this.style[r]=
"center center");g.bind("touchstart",function(a){q+=1;g.css({zIndex:q});d=a.originalEvent.touches.length;m&&(m=!1);if(!m){var b=parseFloat(g.css("left"),10),e=parseFloat(g.css("top"),10),h=a.originalEvent.touches[0].pageX,f=a.originalEvent.touches[0].pageY;v=b;w=e;j=h-b;u=f-e}c.rotate&&(1==d?(x=a.originalEvent.touches[0].pageX,y=a.originalEvent.touches[0].pageY):2==d&&(z=a.originalEvent.touches[1].pageX,A=a.originalEvent.touches[1].pageY,B=180*Math.atan2(y-A,x-z)/Math.PI,C=t,s=!0));c.resize&&2==d&&
(k=g.width(),l=g.height(),h=a.originalEvent.touches[0].pageX,f=a.originalEvent.touches[0].pageY,b=a.originalEvent.touches[1].pageX-h,a=a.originalEvent.touches[1].pageY-f,p=Math.sqrt(b*b+a*a))}).bind("touchmove",function(a){null!=c.callback_touches&&c.callback_touches.apply(this,[d]);if(c.resize&&2==d){var b=a.originalEvent.touches[0].pageX,e=a.originalEvent.touches[0].pageY,b=a.originalEvent.touches[1].pageX-b,e=a.originalEvent.touches[1].pageY-e,b=Math.sqrt(b*b+e*e),h=(b-p)/2,e=k+(b-p),f=l+(b-p),
b=v-h,h=w-h;g.css({width:e+"px",height:f+"px",left:b+"px",top:h+"px"});null!=c.callback_size_change&&c.callback_size_change.apply(this,[e,f]);null!=c.callback_position_change&&c.callback_position_change.apply(this,[b,h])}c.drag&&(!m&&1==d)&&(b=a.originalEvent.touches[0].pageX,e=a.originalEvent.touches[0].pageY,b-=j,h=e-u,g.css({left:b+"px",top:h+"px"}),null!=c.callback_position_change&&c.callback_position_change.apply(this,[b,h]));c.rotate&&s&&(e=t,t=b=-1*(B-180*Math.atan2(a.originalEvent.touches[0].pageY-
a.originalEvent.touches[1].pageY,a.originalEvent.touches[0].pageX-a.originalEvent.touches[1].pageX)/Math.PI-C),this.style[n]="rotate("+Math.floor(b)+"deg)",null!=c.callback_degree_change&&c.callback_degree_change.apply(this,[e,b]));a.preventDefault()}).bind("touchend",function(){d-=1;1==d&&(m=!0);s=!1;null!=c.callback_touches&&c.callback_touches.apply(this,[d])})})};f(document).ready(function(){var j=f(".touch-box");0<j.length&&j.each(function(){var c=f(this),g={drag:!1,resize:!1,rotate:!1},d=c.attr("data-resize"),
j=c.attr("data-drag"),k=c.attr("data-rotate");void 0!=d&&"true"==d&&(g.resize=!0);void 0!=j&&"true"==j&&(g.drag=!0);void 0!=k&&"true"==k&&(g.rotate=!0);c.TouchBox(g)})})})(jQuery);
